<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{/layout/base}" th:with="menu='posts'">

<head>
    <title layout:fragment="title">ìš´ë™ ëª©í‘œ ê´€ë¦¬</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/Exercise.css}"/>
    </th:block>
</head>

<div layout:fragment="content">
    <div class="ExerciseGoal-container">
        <h1 class="ExerciseGoal-title">ìš´ë™ ëª©í‘œ ê´€ë¦¬</h1>
        <div class="ExerciseGoal-description">
            ë‚˜ì˜ ëª©í‘œë¥¼ ì„¤ì •í•˜ê³  ê´€ë¦¬í•´ë³´ì„¸ìš”. í•œ ë²ˆì— í•˜ë‚˜ì˜ ëª©í‘œë§Œ ì ìš©ë©ë‹ˆë‹¤.
        </div>
        <div class="goal-notice">
            <p>ğŸ’¡ ê·¼ìœ¡ ì¦ê°€ ëª©í‘œì¼ ë•Œë§Œ ë¶€ìœ„Â·ì»¨ë””ì…˜ ì¡°ì‚¬ê°€ ì ìš©ë©ë‹ˆë‹¤. ë‹¤ë¥¸ ëª©í‘œë¥¼ ì„ íƒí•˜ë©´ ì´ì „ì— ì…ë ¥í•œ ì»¨ë””ì…˜ ì •ë³´ëŠ” ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
        </div>

        <div id="goal-list" class="ExerciseGoal-goalList"></div>
        <div class="exercisegoal-button-group">
            <button id="btn-add" class="exercisegoal-add-button" type="button">+ ìƒˆ ëª©í‘œ ì¶”ê°€</button>
            <button id="btn-routine" class="exercisegoal-add-button" type="button">+ ìƒˆ ë£¨í‹´ ì¶”ê°€</button>
        </div>
    </div>
</div>
<th:block layout:fragment="script">
    <script>
        const API = '/api/goals';
        const list = document.getElementById('goal-list');

        const csrf = () => {
            const m = document.querySelector('meta[name="_csrf"]');
            return m ? {'X-CSRF-TOKEN': m.content} : {};
        };

        const fmt = iso => iso.slice(0, 10).replace(/-/g, '.');

        (async () => render(await fetchGoals()))();

        async function fetchGoals() {
            const res = await fetch(API, {credentials: 'include'});
            if (!res.ok) throw new Error('ëª©í‘œ ëª©ë¡ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.')
            return res.json();
        }

        function render({goals, selectedGoal}) {
            const selectedId = selectedGoal?.goalId ?? null;
            list.innerHTML = '';

            goals.forEach(g => {
                const diff = g.startWeight - g.targetWeight;
                const card = document.createElement('div');
                card.className = 'ExerciseGoal-goalCard' +
                    (g.goalId === selectedId ? ' ExerciseGoal-selected' : '');
                card.innerHTML = `
                <div class="ExerciseGoal-goalInfo">
                    <h3>
                        <span>${g.goalType}</span>
                        <span class="ExerciseGoal-progressText">ëª©í‘œê¹Œì§€ ${Math.abs(diff)}kg ${diff > 0 ? 'ê°ëŸ‰' : 'ì¦ëŸ‰'} ë‚¨ì•˜ìŠµë‹ˆë‹¤</span>
                    </h3>
                    <p>
                        ê¸°ê°„: ${fmt(g.startDate)} ~ ${fmt(g.endDate)}</p>
                </div>
                <div class="ExerciseGoal-goalActions">
                    ${selectBtn(g.goalId === selectedId, g.goalId)}
                    <button class="ExerciseGoal-selectButton"
                            onclick="location.href='/exercisegoal/goalupdate/${g.goalId}'">
                        ìˆ˜ì •
                    </button>
                    <button class="ExerciseGoal-selectButton" data-delete="${g.goalId}">ì‚­ì œ</button>
                </div>`;

                card.addEventListener('click', e => {
                    if (e.target.closest('.ExerciseGoal-goalActions')) return;
                    location.href = `/exercisegoal/goaldetail/${g.goalId}`;
                });
                list.appendChild(card);
            });
        }

        const selectBtn = (selected, goalId) =>
            selected
                ? `<button class="ExerciseGoal-selectButton ExerciseGoal-active" data-unselect>
                 ì´ ëª©í‘œ ì„ íƒë¨
                 </button>`
                : `<button class="ExerciseGoal-selectButton" data-select="${goalId}">
                 ì´ ëª©í‘œ ì„ íƒ
                </button>`;
            list.addEventListener('click', async e => {
                const {select, unselect, delete: del} = e.target.dataset;
                try {
                    if (select) {
                        const r = await fetch(`${API}/${select}/select`, {
                            method: 'POST',
                            headers: csrf(),
                            credentials: 'include'
                        });
                        const j = await r.json();
                        if (j.alert) alert(j.alert);
                    }
                    if (unselect !== undefined) {
                        await fetch(`${API}/selected`, {
                           method: 'DELETE',
                           headers: csrf(),
                           credentials: 'include'
                        });
                    }
                    if (del) {
                        if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
                        await fetch(`${API}/${del}`, {
                            method: 'DELETE',
                            headers: csrf(),
                            credentials: 'include'
                        });
                    }
                    render(await fetchGoals());
                }   catch (err) {
                    console.error(err);
                    alert('ëª©í‘œë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
            });

            document.getElementById('btn-add')
                    .addEventListener('click', () => location.href = '/exercisegoal/step1');
            document.getElementById('btn-routine')
                    .addEventListener('click', () => location.href = '/routine/create/ai');

    </script>
</th:block>
</html>
