<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/base}" th:with="menu='admin'">
<head>
    <meta charset="UTF-8" />
    <title>AI ìŒì‹ ë¶„ì„</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/foodai.css}">
    </th:block>
</head>

<section layout:fragment="content" class="main">
    <main class="main-content">
        <div class="food-ai-container">
            <div class="section-header">
                <h1><i class="bi bi-camera"></i> AI ìŒì‹ ë¶„ì„</h1>
                <p>ìŒì‹ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´ AIê°€ ìë™ìœ¼ë¡œ ì¹¼ë¡œë¦¬ë¥¼ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤</p>
            </div>

            <div class="upload-section">
                <div class="upload-card">
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="upload-area" id="uploadArea">
                            <h3>ìŒì‹ ì‚¬ì§„ ì—…ë¡œë“œ</h3>
                            <input type="file" name="image" accept="image/*" required id="fileInput" class="file-input">
                            <button type="button" class="upload-btn" onclick="document.getElementById('fileInput').click()">
                                <i class="bi bi-camera"></i> ì‚¬ì§„ ì„ íƒ
                            </button>
                            <div id="preview-area"></div>
                        </div>
                        <div class="btn-wrap" style="margin-top: 10px;">
                            <button type="submit" class="analyze-btn">
                                <i class="bi bi-search"></i> ë¶„ì„í•˜ê¸°
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="result-area" class="result-area"></div>
        </div>
    </main>
</section>

<th:block layout:fragment="script">
    <script>
        // ì„ íƒí•œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        $('#fileInput').on('change', function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#preview-area').html(`<img src="${e.target.result}" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€" class="preview-image-enhanced">`);
                };
                reader.readAsDataURL(file);
            }
        });

        // ë¶„ì„ ìš”ì²­ ì²˜ë¦¬
        $('#upload-form').on('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            $('#result-area').html('<div class="loading-message"><p>ğŸ¥£ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p></div>');

            $.ajax({
                url: 'http://localhost:8000/detect/',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (data) {
                    let resultHtml = '<div class="analysis-results">';
                    resultHtml += '<h3>ë¶„ì„ ê²°ê³¼ (100gë‹¹ ì¹¼ë¡œë¦¬)</h3>';

                    const detectedCounts = data.detected_counts;
                    const estimatedCalories = data.estimated_calories;
                    const totalCalories = data.total_calories;

                    if (Object.keys(detectedCounts).length === 0) {
                        resultHtml += '<div class="no-food-detected">ê°ì§€ëœ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    } else {
                        resultHtml += '<ul class="food-items-list">';
                        for (let food in detectedCounts) {
                            const count = detectedCounts[food];
                            const cal = estimatedCalories[food];
                            resultHtml += `<li>
                                <div>
                                    <strong>${food}</strong>
                                    <span>${count}ê°œ</span>
                                </div>
                                <span class="calories">${cal !== undefined ? cal : '---'} kcal</span>
                            </li>`;
                        }
                        resultHtml += '</ul>';
                    }

                    resultHtml += `<div class="total-calories-summary">
                        <strong>ì´ ì¹¼ë¡œë¦¬</strong>
                        <span class="total-value">${totalCalories} kcal</span>
                    </div>`;
                    resultHtml += '</div>';

                    $('#result-area').html(resultHtml);
                },
                error: function (xhr) {
                    $('#result-area').html(`<div class="error-message"><p>ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${xhr.responseText}</p></div>`);
                }
            });
        });
    </script>
</th:block>

</html>