<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{/layout/base}" th:with="menu='posts'">
<head>
    <title layout:fragment="title">ìš´ë™ í†µê³„ ëŒ€ì‹œë³´ë“œ</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/Exercise.css}"/>
    </th:block>
</head>

<div layout:fragment="content">
    <h1 class="ExerciseStatus-title">ìš´ë™ í†µê³„ ëŒ€ì‹œë³´ë“œ</h1>

    <!-- âœ… ìš´ë™ í†µê³„ ìš”ì•½ ë°•ìŠ¤ -->
    <div class="ExerciseStatus-summary-section">
        <h2 class="ExerciseStatus-subtitle">AI ì¶”ì²œ ë£¨í‹´</h2>
        <p class="ExerciseStatus-stat-item ExerciseStatus-ai-recommend">
            ìµœê·¼ <span class="ExerciseStatus-highlight" th:text="${exerciseStatus.mostUsedPart}"> ìƒì²´ </span>
            ìš´ë™ì´ ë§ì•˜ìŠµë‹ˆë‹¤. <br>
            ì˜¤ëŠ˜ì€ <span class="ExerciseStatus-highlight" th:text="${exerciseStatus.leastUsedPart + ' ì¤‘ì‹¬ ë£¨í‹´'}">í•˜ì²´ ì¤‘ì‹¬ ë£¨í‹´</span>ì„ ì¶”ì²œí•©ë‹ˆë‹¤! ğŸ¦µ
        </p>
        <div class="ExerciseStatus-summary-item">
            ì´ë²ˆ ë‹¬ ì´ ìš´ë™ì‹œê°„:
            <span class="ExerciseStatus-highlight" th:text="${exerciseStatus.monthlyTotalTime}">5ì‹œê°„ 30ë¶„</span>
        </div>
        <div class="ExerciseStatus-summary-item">
            í‰ê·  ì£¼ê°„ ì„±ì‹¤ë„:
            <span class="ExerciseStatus-highlight" th:text="${exerciseStatus.consistencyScore + '%'}">82%</span>
        </div>
        <div class="ExerciseStatus-summary-item">
            ê°€ì¥ ë§ì´ í•œ ìš´ë™ ë¶€ìœ„:
            <span class="ExerciseStatus-highlight" th:text="${exerciseStatus.mostUsedPart}">í•˜ì²´</span>
        </div>
        <div class="ExerciseStatus-summary-item">
            ë¶€ì¡±í•œ ìš´ë™ ë¶€ìœ„:
            <span class="ExerciseStatus-highlight" th:text="${exerciseStatus.leastUsedPart}">ë“±</span>
        </div>
        <a th:href="@{/routine/create/target}" class="ExerciseStatus-recommend-btn">ë¶€ì¡±í•œ ìš´ë™ ì¶”ì²œë°›ê¸°</a>
    </div>

    <!-- ì„±ì‹¤ë„ -->
    <div class="ExerciseStatus-section">
        <h2 class="ExerciseStatus-subtitle">ì´ë²ˆ ì£¼ ì„±ì‹¤ë„</h2>
        <div class="ExerciseStatus-consistency-wrapper">
            <div class="ExerciseStatus-consistency-chart">
                <canvas id="consistencyChart"></canvas>
            </div>
            <div class="ExerciseStatus-consistency-info">
                <p class="ExerciseStatus-stat-item">ì´ ê³„íšëœ ë£¨í‹´: <span class="ExerciseStatus-highlight" th:text="${exerciseStatus.totalRoutineCount}">5ì¼</span></p>
                <p class="ExerciseStatus-stat-item">ì‹¤ì œ ìˆ˜í–‰í•œ ë£¨í‹´: <span class="ExerciseStatus-highlight" th:text="${exerciseStatus.completedSessions}">4ì¼</span></p>
                <p class="ExerciseStatus-stat-item">ì„±ì‹¤ë„ ì ìˆ˜: <span class="ExerciseStatus-highlight" th:text="${exerciseStatus.consistencyScore + '%'}">80%</span></p>
            </div>
        </div>
    </div>

    <!-- ìš´ë™ ë¶€ìœ„ ë°¸ëŸ°ìŠ¤ -->
    <div class="ExerciseStatus-section">
        <h2 class="ExerciseStatus-subtitle">ìš´ë™ ë¶€ìœ„ ë°¸ëŸ°ìŠ¤</h2>
        <div class="ExerciseStatus-chart-container">
            <canvas id="balanceChart"></canvas>
        </div>
    </div>

    <!-- í¼ìŠ¤ë„ ë ˆì½”ë“œ -->
    <div class="ExerciseStatus-section">
        <h2 class="ExerciseStatus-subtitle">í¼ìŠ¤ë„ ë ˆì½”ë“œ (Personal Record)</h2>
        <ul class="ExerciseStatus-record-list">
            <li th:each="record : ${exerciseStatus.personalRecords}">
                ğŸ‹ï¸<span th:text="${record['exerciseName']}"></span> :
                <span th:text="${record['maxWeight'] + 'kg'}" class="ExerciseStatus-highlight">120kg</span>
                (<span th:text="${record['recordDate']}"></span>)
            </li>
        </ul>
    </div>

    <!-- ìš´ë™ ì¶”ì´ -->
    <div class="ExerciseStatus-section">
        <h2 class="ExerciseStatus-subtitle">ìš´ë™ ìˆ˜í–‰ëŸ‰ ì¶”ì´ (6ì›”)</h2>
        <div class="ExerciseStatus-chart-container" style="max-width: 600px;">
            <canvas id="progressChart"></canvas>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë²„íŠ¼ -->
    <div class="ExerciseStatus-button-container">
        <a href="/myexercise" class="ExerciseStatus-btn">ë‚˜ì˜ ìš´ë™ìœ¼ë¡œ ê°€ê¸°</a>
        <a href="/exercisegoal/goallist" class="ExerciseStatus-btn">ìš´ë™í•˜ëŸ¬ ê°€ê¸°</a>
    </div>
    <th:block layout:fragment="script">
        <!-- Chart.js + Plugin -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
        <script th:inline="javascript">
            const consistencyScore = /*[[${exerciseStatus.consistencyScore}]]*/ 0; // ì˜ˆ: 80
            const dailyLabels = /*[[${exerciseStatus.dailyLabels}]]*/ []; // ["ì›”","í™”",...]
            const dailyData = /*[[${exerciseStatus.dailyData}]]*/ []; // [2,1,0,2,1,0,0]
            const balanceLabels = /*[[${exerciseStatus.balanceLabels}]]*/ []; // ["ìƒì²´","í•˜ì²´","ì½”ì–´"]
            const balanceData = /*[[${exerciseStatus.balanceData}]]*/ []; // [50,35,15]

            const centerTextPlugin = {
                id: 'centerText',
                beforeDraw: function (chart) {
                    const {width, height, ctx} = chart;
                    ctx.restore();
                    const fontSize = (height / 8).toFixed(2);
                    ctx.font = `bold ${fontSize}px Segoe UI`;
                    ctx.textBaseline = "middle";
                    ctx.fillStyle = '#ffffff';
                    const lines = ["ì„±ì‹¤ë„", consistencyScore + "%"];
                    const lineHeight = height / 6;
                    lines.forEach((line, i) => {
                        const textX = (width - ctx.measureText(line).width) / 2;
                        const textY = height / 2 - lineHeight + i * lineHeight;
                        ctx.fillText(line, textX, textY);
                    });
                    ctx.save();
                }
            };

            new Chart(document.getElementById('consistencyChart'), {
                type: 'doughnut',
                data: {
                    labels: ['ë‹¬ì„±', 'ë¯¸ë‹¬ì„±'],
                    datasets: [{
                        data: [consistencyScore, 100 - consistencyScore],
                        backgroundColor: ['#4caf50', '#424242'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: {display: false},
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.label}: ${context.raw}%`;
                                }
                            }
                        }
                    }
                },
                plugins: [centerTextPlugin]
            });

            new Chart(document.getElementById('balanceChart'), {
                type: 'pie',
                data: {
                    labels: balanceLabels,
                    datasets: [{
                        data: balanceData,
                        backgroundColor: ['#4caf50', '#2196f3', '#ff9800']
                    }]
                },
                options: {
                    maintainAspectRatio: true,
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {color: '#fff'}
                        },
                        datalabels: {
                            color: '#fff',
                            font: {weight: 'bold', size: 14},
                            formatter: (value, ctx) => {
                                const label = ctx.chart.data.labels[ctx.dataIndex];
                                return `${label} ${value}%`;
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            new Chart(document.getElementById('progressChart'), {
                type: 'bar',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'ì´ ìˆ˜í–‰ ìš´ë™ ìˆ˜',
                        data: dailyData,
                        backgroundColor: '#00bcd4',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {ticks: {color: '#fff'}, grid: {color: '#333'}},
                        y: {beginAtZero: true, ticks: {color: '#fff'}, grid: {color: '#333'}}
                    },
                    plugins: {
                        legend: {labels: {color: '#fff'}}
                    }
                }
            });
        </script>
    </th:block>
</div>
</html>
