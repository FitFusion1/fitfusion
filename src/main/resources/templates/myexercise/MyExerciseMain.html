<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/base}">

<head>
    <title layout:fragment="title">ë‚˜ì˜ ìš´ë™ ëŒ€ì‹œë³´ë“œ</title>

    <!-- ê¸°ì¡´ Exercise.css -->
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/Exercise.css}"/>
    </th:block>
</head>

<div layout:fragment="content">
    <div class="MyExercise-container">
        <h1 class="MyExercise-title">ë‚˜ì˜ ìš´ë™</h1>

        <!-- 1. ìš´ë™ ëª©í‘œ -->
        <div class="MyExercise-section">
            <div class="MyExercise-section-header">
                <h2>ğŸ¯ ìš´ë™ ëª©í‘œ</h2>
                <a class="MyExercise-btn" href="/exercisegoal/goallist">ì „ì²´ë³´ê¸°</a>
            </div>
            <div id="goal-info" class="MyExercise-highlight">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <!-- 2. ìš´ë™ í†µê³„ (ì¦‰ì‹œ ë Œë”) -->
        <div class="MyExercise-section">
            <div class="MyExercise-section-header">
                <h2>ğŸ“Š ìš´ë™ í†µê³„</h2>
                <a class="MyExercise-btn" href="/myexercise/exercisestatus">ì „ì²´ë³´ê¸°</a>
            </div>
            <div id="status-card" class="MyExercise-highlight"></div>
        </div>


        <!-- 3. ìµœê·¼ ë£¨í‹´ -->
        <div class="MyExercise-section">
            <div class="MyExercise-section-header">
                <h2>ğŸ’ª ìµœê·¼ ë£¨í‹´</h2>
                <a class="MyExercise-btn" href="/routine/list">ì „ì²´ë³´ê¸°</a>
            </div>
            <div id="routine-container" class="MyExercise-card-container"></div>
        </div>

        <!-- 4. ìµœê·¼ ìˆ˜í–‰ ìš´ë™ -->
        <div class="MyExercise-section">
            <div class="MyExercise-section-header">
                <h2>ğŸ“‹ ìµœê·¼ ìˆ˜í–‰ ìš´ë™</h2>
                <a class="MyExercise-btn" href="/exerciseLog/list">ì „ì²´ë³´ê¸°</a>
            </div>
            <div id="log-container" class="MyExercise-card-container"></div>
        </div>


        <!-- 5~8. í†µê³„(ì„¸ë¡œ ë¬´í•œìŠ¤í¬ë¡¤) -->
        <div id="stats-container"></div>
        <div id="stats-scroll-trigger" style="height:70px;"></div>
    </div>
</div>

<!-- ... ìœ„ìª½ HTML ë™ì¼ ... -->
<th:block layout:fragment="script">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userId = 3;   // ì‹¤ì œ ë¡œê·¸ì¸ IDë¡œ êµì²´

            /* 1) ëª©í‘œ -------------------------------------------------- */
            fetch(`/api/myExercise/goal?userId=${userId}`)
                .then(r => r.json())
                .then(g => {
                    const box = document.getElementById('goal-info');

                    if (g && g.goalType) {
                        // í•„ìš”í•˜ë©´ ì¦Â·ê°ëŸ‰ kg ê³„ì‚°
                        const diff = Math.abs(g.startWeight - g.targetWeight);

                        box.innerHTML = `
        <span class="ExerciseStatus-highlight">${g.goalType}</span> ëª©í‘œë¥¼ ì„¸ì› ìŠµë‹ˆë‹¤!<br>
        ì‹œì‘ ëª¸ë¬´ê²Œ : <span class="ExerciseStatus-highlight">${g.startWeight}kg&nbsp;&nbsp;</span>
        ëª©í‘œ ì²´ì¤‘ : <span class="ExerciseStatus-highlight">${g.targetWeight}kg</span>
        <span class="Goal-gap">(${diff}kg ${g.startWeight > g.targetWeight ? 'ê°ëŸ‰' : 'ì¦ëŸ‰'} í•„ìš”)</span>
      `;

                        box.style.cursor = 'pointer';
                        box.addEventListener('click', () => {
                            location.href = `/exercisegoal/goaldetail/${g.goalId}`
                        });
                    } else {
                        box.textContent = 'ëª©í‘œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                    }
                });

            /* 2) ìµœê·¼ ë£¨í‹´ -------------------------------------------- */
            fetch(`/api/myExercise/routines?userId=${userId}`)
                .then(r => r.json())
                .then(list => {
                    const box = document.getElementById('routine-container');
                    list.forEach(rt => {
                        const c = document.createElement('div');
                        c.className = 'MyExercise-card';
                        c.innerHTML = `<strong>${rt.routineName}</strong><br>${rt.exerciseCount}ê°œ ìš´ë™`;
                        box.appendChild(c);

                        box.style.cursor = 'pointer';
                        c.addEventListener('click', () =>{
                            location.href = `/routine/detail/${rt.routineId}`
                        });
                    });
                });

            /* 3) ìµœê·¼ ìˆ˜í–‰ ìš´ë™ ---------------------------------------- */
            fetch(`/api/myExercise/exercise-logs?userId=${userId}`)
                .then(r => r.json())
                .then(list => {
                    const box = document.getElementById('log-container');
                    list.forEach(l => {
                        const c = document.createElement('div');
                        c.className = 'MyExercise-card';
                        c.innerHTML = `<strong>${l.exerciseName}</strong><br>${l.sets}ì„¸íŠ¸ / ${l.reps}íšŒ`;
                        box.appendChild(c);
                    });
                });

            /* 4) ìš´ë™ í†µê³„(ì¦‰ì‹œ) ------------------------------------ */
            fetch(`/api/myExercise/exercise-status?userId=${userId}`)
                .then(r => r.json())
                .then(d => statusCard(d));

            function statusCard(s) {
                const box = document.getElementById('status-card');
                box.innerHTML = `
        <div class="MyExercise-highlight">
        <h2 class="ExerciseStatus-subtitle">AI ì¶”ì²œ ë£¨í‹´</h2>
        <p class="ExerciseStatus-stat-item ExerciseStatus-ai-recommend">
            ìµœê·¼ <span class="ExerciseStatus-highlight">${s.mostUsedPart}</span>
            ìš´ë™ì´ ë§ì•˜ìŠµë‹ˆë‹¤. <br>
            ì˜¤ëŠ˜ì€ <span class="ExerciseStatus-highlight">${s.leastUsedPart + ' ì¤‘ì‹¬ ë£¨í‹´'}</span>ì„ ì¶”ì²œí•©ë‹ˆë‹¤! ğŸ¦µ
        </p>
        <div class="ExerciseStatus-summary-item">
            ì´ë²ˆ ë‹¬ ì´ ìš´ë™ì‹œê°„:
            <span class="ExerciseStatus-highlight">${s.monthlyTotalTime}</span>
        </div>
        <div class="ExerciseStatus-summary-item">
            í‰ê·  ì£¼ê°„ ì„±ì‹¤ë„:
            <span class="ExerciseStatus-highlight">${s.consistencyScore + '%'}</span>
        </div>
        <div class="ExerciseStatus-summary-item">
            ê°€ì¥ ë§ì´ í•œ ìš´ë™ ë¶€ìœ„:
            <span class="ExerciseStatus-highlight">${s.mostUsedPart}</span>
        </div>
        <div class="ExerciseStatus-summary-item">
            ë¶€ì¡±í•œ ìš´ë™ ë¶€ìœ„:
            <span class="ExerciseStatus-highlight"">${s.leastUsedPart}</span>
        </div>
        <a href="/routine/create/target" class="ExerciseStatus-recommend-btn">ë¶€ì¡±í•œ ìš´ë™ ì¶”ì²œë°›ê¸°</a>
    </div>`;
            }

            /* ---------- í†µê³„ ì¹´ë“œ ë¬´í•œìŠ¤í¬ë¡¤ ---------- */
            const meta = [
                {key: 'consistency', title: 'ğŸ“Š ì´ë²ˆ ì£¼ ì„±ì‹¤ë„'},
                {key: 'balance', title: 'ğŸ§© ìš´ë™ ë¶€ìœ„ ë°¸ëŸ°ìŠ¤'},
                {key: 'records', title: 'ğŸ‹ï¸ í¼ìŠ¤ë„ ë ˆì½”ë“œ'},
                {key: 'progress', title: 'ğŸ“ˆ ìš´ë™ ìˆ˜í–‰ëŸ‰ ì¶”ì´'}
            ];
            let step = 0;

            /* â–£ ì°¨íŠ¸ helper â–£ ----------------------------------------- */
            const drawDonut = (ctx, d) => new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ë‹¬ì„±', 'ë¯¸ë‹¬ì„±'],
                    datasets: [{data: d, backgroundColor: ['#4caf50', '#424242']}]
                },
                options: {responsive: true, maintainAspectRatio: false}
            });

            const drawPie = (ctx, l, d) => new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: l,
                    datasets: [{
                        data: d,
                        backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#9c27b0']
                    }]
                },
                options: {responsive: true, maintainAspectRatio: false}
            });

            const drawBar = (ctx, l, d) => new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: l,
                    datasets: [{label: 'ìš´ë™ íšŸìˆ˜', data: d, backgroundColor: '#00bcd4'}]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {y: {beginAtZero: true}}
                }
            });

            /* sentinel ì¤€ë¹„ */
            const sentinel = document.getElementById('stats-scroll-trigger');
            sentinel.style.height = '1px';

            const loadCard = () => {
                if (step >= meta.length) return;
                fetch(`/api/myExercise/exercise-status?userId=${userId}`)
                    .then(r => r.json())
                    .then(d => {
                        const cur = meta[step];
                        const wrap = document.getElementById('stats-container');
                        const card = document.createElement('div');
                        card.className = 'MyExercise-section';

                        const head = `<div class="MyExercise-section-header"><h2>${cur.title}</h2></div>`;

                        /* âœ¦ ê° ì¹´ë“œ ë¶„ê¸° ------------------------------------ */
                        if (cur.key === 'consistency') {
                            card.innerHTML = head + `<div class="chart-container">
            <canvas id="c-${cur.key}"></canvas></div>`;
                            setTimeout(() => drawDonut(
                                document.getElementById(`c-${cur.key}`),
                                [d.consistencyScore, 100 - d.consistencyScore]), 10);
                        }
                        if (cur.key === 'balance') {
                            card.innerHTML = head + `<div class="chart-container">
            <canvas id="c-${cur.key}"></canvas></div>`;
                            setTimeout(() => drawPie(
                                document.getElementById(`c-${cur.key}`),
                                d.balanceLabels, d.balanceData), 10);
                        }
                        if (cur.key === 'records') {
                            const li = d.personalRecords
                                .map(v => `<li>${v.exerciseName}: ${v.maxWeight}kg (${v.recordDate})</li>`).join('');
                            card.innerHTML = head + `<ul class="MyExercise-stat-list">${li}</ul>`;
                        }
                        if (cur.key === 'progress') {
                            card.innerHTML = head + `<div class="wide-chart">
            <canvas id="c-${cur.key}"></canvas></div>`;
                            setTimeout(() => drawBar(
                                document.getElementById(`c-${cur.key}`),
                                d.dailyLabels, d.dailyData), 10);
                        }

                        /* ì¹´ë“œ + sentinel ì‚½ì… */
                        wrap.appendChild(card);
                        wrap.appendChild(sentinel);
                        step++;
                    });
            };

            new IntersectionObserver(e => {
                if (e[0].isIntersecting) loadCard();
            }, {rootMargin: '0px 0px 0% 0px'}).observe(sentinel);
        });
    </script>
</th:block>
</html>
