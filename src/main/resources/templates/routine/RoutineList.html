<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{/layout/base}" th:with="menu='posts'">
<head>
    <title layout:fragment="title">운동 루틴</title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/Exercise.css}"/>
    </th:block>
</head>

<div layout:fragment="content">
    <div class="RoutineList-container">
        <h1 class="RoutineList-title">나의 운동 루틴</h1>

        <button class="RoutineList-addButton custom-create"
                th:onclick="|location.href='/routine/create/custom'|">+ 나만의 루틴 생성하기
        </button>
        <button class="RoutineList-addButton ai-create"
                th:onclick="|location.href='/routine/create/ai'|">+ AI 루틴 생성하기
        </button>

        <div id="routine-list" class="RoutineList-grid"></div>

        <div id="scroll"></div>

    </div>
</div>
<th:block layout:fragment="script">
    <script>
        const API = '/api/routines'
        const list = document.getElementById('routine-list');
        const scroll = document.getElementById('scroll');

        const csrf = () => {
            const m = document.querySelector('meta[name="_csrf"]');
            return m ? {'X-CSRF-TOKEN': m.content} : {};
        };

        let page = 1;
        const size = 6;
        let totalPages = Infinity;

        async function loadPage() {
            if (page > totalPages) return;
            try {
                const res = await fetch(`${API}?page=${page}&size=${size}`, {
                   credentials: 'include',
                   headers: csrf()
                });
                if (!res.ok) throw new Error('로드 실패');
                const {data: routines, meta} = await res.json();
                totalPages = meta.totalPage;
                routines.forEach(routine => appendCard(routine));
                page++;
            } catch (err) {
                console.error(err);
                alert('루틴 목록을 불러오는 중 오류가 발생했습니다.');
            }
        }

        function appendCard(routine) {
            const card = document.createElement('div');
            card.className = 'RoutineList-card';
            card.innerHTML = `
                <div class="RoutineList-cardTitle">${routine.routineName}</div>
                <span class="RoutineList-tag">${routine.targetPart}</span>
                <span class="RoutineList-tag">${routine.difficulty}</span>
                <span class="RoutineList-tag">${routine.totalTime}</span>
                <div class="RoutineList-meta">${routine.summary}</div>
                <div class="RoutineList-buttonGroup">
                    <button data-routine-id="${routine.routineId}" type="button" class="RoutineList-button RoutineList-start">수행</button>
                    <button data-routine-id="${routine.routineId}" type="button" class="RoutineList-button RoutineList-edit">수정</button>
                    <button data-routine-id="${routine.routineId}" type="button" class="RoutineList-button RoutineList-delete">삭제</button>
                </div>
            `;
            card.addEventListener('click', e => {
                if (e.target.closest('.RoutineList-buttonGroup')) return;
                location.href = `/routine/detail/${routine.routineId}`;
            });
            list.appendChild(card);
        }


        list.addEventListener('click', async e => {
            const routineId = e.target.dataset.routineId
            try {
                if (e.target.classList.contains('RoutineList-start')) {
                    location.href = `/routine/execute/${routineId}`
                }
                if (e.target.classList.contains('RoutineList-edit')) {
                    location.href = `/routine/update/${routineId}`
                }
                if (e.target.classList.contains('RoutineList-delete')) {
                    if (!confirm('정말 삭제할까요?')) return;
                    const d = await fetch(`${API}/${routineId}`, {
                        method: 'DELETE',
                        credentials: 'include',
                        headers: csrf()
                    });
                    if (!d.ok) throw new Error('삭제 실패');
                    list.innerHTML = '';
                    page = 1;
                    totalPages = Infinity;
                    loadPage();
                }
            } catch (err) {
                console.error(err);
                alert('작업 중 오류가 발생했습니다.')
            }
        });

        const io = new IntersectionObserver(entries => {
            if (entries[0].isIntersecting) loadPage();
        }, {
            root: null,
            rootMargin: '0px 0px -200px 0px',
            threshold: 0
        });

        loadPage();
        io.observe(scroll);
    </script>
</th:block>
</html>
